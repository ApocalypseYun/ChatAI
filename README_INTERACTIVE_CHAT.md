# 10轮互动聊天功能说明

## 功能概述

当请求中带有预设的 `type` 参数（S001、S002、S003）时，系统支持最多10轮的互动聊天，并通过智能引导帮助用户完成正常业务流程。

## 主要特性

### 1. 轮次限制
- 最大对话轮次：7轮
- 轮次计算：`len(history) // 2`（每轮包含用户消息和AI回复）
- 超过10轮后自动转人工客服

### 2. 智能引导策略
根据对话轮次采用不同的引导策略：

#### 轮次分级处理
- **1-4轮**：正常优先级，耐心引导
- **5-6轮**：中等优先级，更明确地引导用户提供必要信息
- **7-9轮**：高优先级，积极引导，提醒时间限制
- **10轮**：自动转人工客服

#### 业务特定引导
- **S001/S002（充值/提现查询）**：引导用户提供18位订单号
- **S003（活动查询）**：引导用户从可用活动列表中选择具体活动

### 3. 自适应响应机制

#### 0阶段处理（非业务相关询问）
- **无预设type**：直接转人工
- **有预设type**：使用引导策略引导用户回到正常流程

#### 业务流程中的引导
- **订单号提取失败（5轮后）**：使用引导策略而非标准错误回复
- **活动识别不明确（3轮后）**：使用引导策略结合活动列表
- **其他阶段**：保持原有逻辑

## 实现机制

### 核心函数
位于 `src/reply.py` 文件中：
```python
def build_guidance_prompt(message_type: str, conversation_rounds: int, 
                         user_message: str, history: list, 
                         language: str) -> str
```

### 关键参数
- `message_type`: 业务类型（S001/S002/S003）
- `conversation_rounds`: 当前对话轮次
- `user_message`: 用户当前消息
- `history`: 对话历史
- `language`: 语言设置

### 元数据记录
响应中包含以下元数据：
```json
{
    "conversation_rounds": 5,
    "max_rounds": 10,
    "has_preset_type": true,
    "rounds_exceeded": false
}
```

## 使用示例

### 带type的请求
```json
{
    "session_id": "sess_123",
    "user_id": "user_456",
    "platform": "web",
    "language": "zh",
    "status": 1,
    "type": "S001",
    "messages": "我想查询充值",
    "history": [...],
    "site": 1,
    "token": "valid_token"
}
```

### 引导回复示例
```json
{
    "session_id": "sess_123",
    "status": "success",
    "response": "我理解您想查询充值状态。为了帮您查询，请提供您的18位订单号。如果您找不到订单号，可以在您的账户历史记录中查看，或者告诉我大概的充值时间和金额。",
    "stage": "working",
    "metadata": {
        "intent": "S001",
        "conversation_rounds": 3,
        "max_rounds": 10,
        "has_preset_type": true
    },
    "type": "S001",
    "transfer_human": 0
}
```

## 多语言支持

引导功能支持以下语言：
- **中文（zh）**：简体中文
- **英文（en）**：英语
- **泰文（th）**：ไทย
- **菲律宾语（tl）**：Filipino/Tagalog
- **日文（ja）**：日本語

每种语言都有对应的：
- 业务类型描述
- 引导优先级说明
- 聊天历史角色标识
- 完整的引导提示词模板

## 日志记录

系统会记录详细的引导过程日志：
- 轮次检查和策略选择
- 引导模式激活
- 多轮对话后的处理决策
- 转人工的触发原因

## 配置要求

无需额外配置，功能自动激活当：
1. 请求包含有效的 `type` 参数
2. `type` 为支持的业务类型（S001、S002、S003）
3. 用户状态为已登录（`status: 1`）

## 注意事项

1. 仅在有预设 `type` 时启用引导功能
2. 未登录用户不支持此功能
3. 图片上传仍会直接转人工处理
4. API调用异常时按原逻辑处理
5. 10轮限制为硬性限制，超过后必定转人工 